# 气旋预报大语言模型数据集规范文档

## 1. 项目概述

本项目旨在使用大语言模型（LLM）通过监督微调（SFT）和群体相对策略优化（GRPO）方法学习气旋预报任务。**核心目标是让LLM学习人类预报员的决策过程和思维链**，综合真实观测数据、多个数值模式的预报路径和环境场信息，对气旋的未来路径和强度（最小压力和最大风速）做出准确预报。

由于缺乏真实预报员的决策记录，本项目将采用**LLM辅助生成**的方式，基于历史数据和预设规则，构建高质量的预报决策样本（包括完整的思维链），用于后续的模型训练。

## 2. 现有数据资源

### 2.1 真实气旋路径数据
- **文件**: `input/western_pacific_typhoons_superfast.csv`
- **内容**: 西太平洋气旋的历史真实路径数据
- **字段**:
  - `storm_id`: 气旋唯一标识符
  - `storm_name`: 气旋名称
  - `datetime`: 时间戳（3小时间隔）
  - `latitude`, `longitude`: 气旋位置
  - `max_wind_wmo`, `max_wind_usa`: 最大风速（WMO和USA标准）
  - `min_pressure_wmo`, `min_pressure_usa`: 最小气压（WMO和USA标准）
  - `storm_speed`, `storm_direction`: 移动速度和方向
  - `distance_to_land`: 距离陆地距离

### 2.2 真实环境场数据
- **目录**: `data/cds_output_trusted/`
- **格式**: 按月汇总的JSON文件（如 `cds_environment_analysis_2006-03.json`）
- **内容**: 从真实路径数据中提取的气旋所在时间点的环境场信息
- **关键信息**:
  - 副热带高压系统（位置、强度、形态、引导气流）
  - 海洋热含量（海表温度、暖水区域范围）
  - 垂直风切变
  - 其他天气系统（槽、脊等）

### 2.3 模型预报路径数据
- **目录**: `data/track_single/`
- **格式**: CSV文件，命名规则为 `tracks_{模型}_{初始化时间}_f000_f240_06.csv`
- **内容**: 不同数值预报模型（如GFS、IFS）追踪的气旋路径
- **特点**:
  - 单次预报可能追踪出一条或多条路径
  - 每6小时一个预报时次
  - 预报时效最长240小时（10天）
  - 字段包括: `time`, `lat`, `lon`, `msl`(气压), `wind`(风速), `particle`(气旋ID), `time_idx`

### 2.4 预报环境场数据
- **目录**: `data/final_single_output_trusted/`
- **格式**: JSON文件，命名规则为 `{模型}_{版本}_{数据源}_{初始化时间}_TC_Analysis_{气旋ID}.json`
- **内容**: 基于模型预报路径提取的天气系统信息
- **关键信息**:
  - 与真实环境场数据结构类似
  - 包含时间序列的环境场演变
  - 提供预报时刻的环境系统配置
  - 文件名包含模型元数据（如FOUR_v200_IFS、GRAP_v100_GFS等）

## 3. 数据集构建方案

### 3.1 整体架构

数据集构建分为两个阶段：
1. **数据生成阶段**：使用LLM辅助生成预报员决策数据（包括思维链）
2. **模型训练阶段**：基于生成的数据进行SFT和GRPO训练

#### 3.1.1 预报员决策数据生成（LLM辅助）

**目标**: 基于历史真实数据和模型预报，生成符合预报员思维逻辑的决策样本

**生成流程**:
```
For 每个历史预报时刻:
  输入到生成LLM:
    - 当前及历史观测数据
    - 多个数值模式预报（路径+环境场）
    - 预报任务要求
  
  生成LLM输出:
    - 详细的思维链分析
      * 当前形势判断
      * 各模式预报对比
      * 环境场影响分析
      * 不确定性识别
    - 最终预报结果（路径+强度）
    - 预报置信度说明
  
  质量控制:
    - 对比真实结果，筛选合理样本
    - 调整生成规则，迭代优化
```

**生成规则设计**:
1. **多模式权衡规则**:
   - 模式一致性高 → 高置信度预报
   - 模式分歧大 → 分析分歧原因，采用折中或偏向某模式
   - 参考模式历史表现（如可用）

2. **环境场分析规则**:
   - 副高位置与强度 → 引导气流判断
   - 海表温度 → 强度发展潜力
   - 垂直风切变 → 强度维持或减弱
   - 天气系统相互作用 → 路径偏折可能

3. **思维链结构**:
   ```
   第一步：形势分析 - 当前气旋状态和环境配置
   第二步：历史趋势 - 过去24小时的移动和强度变化
   第三步：模式对比 - 各模式预报差异分析
   第四步：环境演变 - 未来环境场变化预判
   第五步：综合判断 - 形成最终预报意见
   第六步：不确定性 - 识别关键不确定因素
   ```

#### 3.1.2 SFT阶段数据集

**目标**: 使用LLM生成的决策数据训练预报模型

**数据样本构成**:
```
输入 (Prompt):
- 当前时刻 T0
- 真实观测历史 (T0-24h 到 T0)
  * 气旋位置、强度轨迹
  * 移动趋势和强度变化
- 当前环境场信息（真实）
- 多个模型预报 (T0 到 T0+72h)
  * 各模型路径预报
  * 各模型环境场预报
- 预报任务要求

输出 (Response):
- 思维链分析过程（LLM生成）
- 预报路径和强度
- 预报依据说明
```

**数据来源**: LLM辅助生成 + 人工质量控制

#### 3.1.3 GRPO阶段数据集

**目标**: 通过策略优化提高预报准确度

**奖励设计**:
- **主要奖励**: 路径和强度预报准确度
  * 路径误差：预报位置与真实位置的距离偏差
  * 强度误差：预报强度（气压、风速）与真实值的差异
  * 时效衰减：短期预报权重高于长期预报
  
- **次要奖励**: 思维链质量
  * 逻辑连贯性：推理步骤是否合理
  * 模式利用：是否有效利用了多模式信息
  * 不确定性识别：是否正确识别了不确定因素

**数据来源**: SFT模型生成多个候选预报，根据真实结果计算奖励

### 3.2 现有数据处理流程

#### 3.2.1 数据预处理

**步骤1: 数据清洗和标准化**
```python
# 1. 统一时间格式
- 将所有数据源时间统一为UTC
- 时间分辨率对齐（主要为6小时间隔）

# 2. 坐标和单位标准化
- 经纬度统一为 -180~180° 格式
- 气压单位统一为 hPa
- 风速单位统一为 m/s

# 3. 模型元数据提取
- 从文件名解析：模型名称、版本、数据源、初始化时间
- 示例: FOUR_v200_IFS_20220911T000000 → 
  {model: "FOUR", version: "v200", source: "IFS", init_time: "2022-09-11 00:00"}
```

**步骤2: 时空匹配**
```python
For 每个真实气旋时刻 (storm_id, datetime):
  # 1. 提取历史观测
  历史轨迹 = 提取前24小时数据(storm_id, datetime)
  
  # 2. 提取当前环境场
  当前环境 = 查找cds_output_trusted(datetime)
  
  # 3. 匹配可用模型预报
  可用预报 = []
  For 每个模型预报文件 in track_single:
    if 预报初始化时间 == datetime:
      预报路径 = 读取预报轨迹()
      预报环境 = 查找final_single_output_trusted(模型, datetime, storm_id)
      
      if 预报路径 and 预报环境:
        可用预报.append({
          "模型": 从文件名提取(model, version, source),
          "路径": 预报路径,
          "环境场": 预报环境
        })
  
  # 4. 提取未来真值（用于标签和质量控制）
  未来真值 = 提取未来72小时数据(storm_id, datetime)
  
  # 5. 保存匹配结果
  保存({
    "storm_id": storm_id,
    "forecast_time": datetime,
    "history": 历史轨迹,
    "current_env": 当前环境,
    "model_forecasts": 可用预报,
    "ground_truth": 未来真值
  })
```

#### 3.2.2 LLM辅助数据生成

**步骤1: 构建生成提示词模板**
```python
def build_generation_prompt(data):
    """
    构建用于生成预报决策的提示词
    """
    prompt = f"""你是一位经验丰富的台风预报专家。请根据以下信息进行详细的预报分析，并给出未来72小时的路径和强度预报。

【基本信息】
- 预报时间: {data['forecast_time']}
- 台风编号: {data['storm_id']}
- 当前位置: {data['current_position']}
- 当前强度: 中心气压 {data['current_pressure']} hPa, 最大风速 {data['current_wind']} m/s

【历史演变（过去24小时）】
{format_history(data['history'])}

【当前环境场分析】
{format_environment(data['current_env'])}

【数值模式预报】
{format_model_forecasts(data['model_forecasts'])}

请按以下步骤进行分析：
1. **形势分析**: 评估当前台风状态和所处环境
2. **历史趋势**: 分析过去24小时的移动和强度变化特征
3. **模式对比**: 对比各数值模式预报，分析差异和可信度
4. **环境演变**: 预判未来环境场变化及其对台风的影响
5. **综合判断**: 综合以上分析，给出最终预报
6. **不确定性**: 指出预报中的主要不确定因素

最后，请给出具体的预报结果：
- 24小时预报: 位置(纬度, 经度), 强度(中心气压, 最大风速)
- 48小时预报: 位置(纬度, 经度), 强度(中心气压, 最大风速)
- 72小时预报: 位置(纬度, 经度), 强度(中心气压, 最大风速)
"""
    return prompt
```

**步骤2: 批量生成预报决策数据**
```python
# 使用强大的LLM（如GPT-4, Claude）生成预报决策
For 每个匹配样本 in 预处理数据:
  # 构建提示词
  prompt = build_generation_prompt(匹配样本)
  
  # 调用LLM生成
  response = call_llm(prompt, temperature=0.7)
  
  # 解析生成结果
  parsed = parse_forecast_response(response)
  
  # 质量控制
  if quality_check(parsed, 匹配样本['ground_truth']):
    保存生成样本({
      "prompt": prompt,
      "response": response,
      "parsed_forecast": parsed,
      "ground_truth": 匹配样本['ground_truth']
    })
```

**步骤3: 质量控制和筛选**
```python
def quality_check(forecast, ground_truth):
    """
    检查生成的预报质量
    """
    # 1. 格式检查
    if not all(key in forecast for key in ['24h', '48h', '72h']):
        return False
    
    # 2. 合理性检查
    for time_step in ['24h', '48h', '72h']:
        # 位置不能偏离过远
        distance = haversine(forecast[time_step]['position'], 
                           ground_truth[time_step]['position'])
        if distance > 1000:  # 超过1000km可能不合理
            return False
        
        # 强度变化不能过于剧烈
        pressure_change = abs(forecast[time_step]['pressure'] - 
                             forecast['current']['pressure'])
        if pressure_change > 100:  # 气压变化超过100hPa不合理
            return False
    
    # 3. 思维链完整性检查
    required_steps = ['形势分析', '历史趋势', '模式对比', 
                     '环境演变', '综合判断', '不确定性']
    if not all(step in forecast['reasoning'] for step in required_steps):
        return False
    
    return True
```

**步骤4: 迭代优化**
```python
# 根据生成质量调整提示词和生成参数
# 可以添加少样本示例（few-shot examples）提高生成质量
# 对质量较差的样本重新生成
```
   - 以模型预报初始化时间为基准
   - 匹配该时刻及之前24小时的真实观测数据
   - 提取该时刻所有可用的模型预报

2. **空间对齐**:
   - 根据真实路径数据的storm_id匹配预报数据
   - 预报路径中的particle字段对应真实气旋ID
#### 3.2.3 SFT和GRPO数据集构建

**SFT数据集构建**:
```python
sft_dataset = []

For 每个生成样本 in LLM生成数据:
  sft_sample = {
    "instruction": "你是一位台风预报专家，请根据观测数据和数值模式预报进行分析并给出预报。",
    "input": 生成样本['prompt'],  # 包含历史、环境、模式预报
    "output": 生成样本['response'],  # 包含思维链和预报结果
    "metadata": {
      "storm_id": 生成样本['storm_id'],
      "forecast_time": 生成样本['forecast_time'],
      "ground_truth": 生成样本['ground_truth']  # 用于后续评估
    }
  }
  sft_dataset.append(sft_sample)

# 保存为训练格式（如JSONL）
save_jsonl(sft_dataset, "sft_training_data.jsonl")
```

**GRPO数据集构建**:
```python
# GRPO阶段使用SFT模型生成多个候选预报
grpo_dataset = []

For 每个预处理样本 in 验证集:
  # 使用SFT模型生成多个候选（采样多次）
  candidates = []
  for i in range(5):  # 生成5个候选
    response = sft_model.generate(
      prompt=预处理样本['prompt'],
      temperature=0.8  # 较高温度增加多样性
    )
    parsed = parse_forecast_response(response)
    
    # 计算奖励
    reward = calculate_reward(parsed, 预处理样本['ground_truth'])
    
    candidates.append({
      "response": response,
      "forecast": parsed,
      "reward": reward
    })
  
  grpo_sample = {
    "prompt": 预处理样本['prompt'],
    "candidates": candidates,
    "ground_truth": 预处理样本['ground_truth']
  }
  grpo_dataset.append(grpo_sample)

save_jsonl(grpo_dataset, "grpo_training_data.jsonl")
```

## 4. 缺失数据分析与解决方案

### 4.1 预报员决策记录 ✅ **已通过LLM生成解决**
**原缺失内容**:
- 历史业务预报结果
- 预报员的推理过程和依据（思维链）
- 预报员如何权衡不同模型

**解决方案**: 
- ✅ 使用强大的LLM（GPT-4/Claude等）基于历史数据生成预报决策
- ✅ 设计详细的生成规则和提示词模板，确保思维链完整性
- ✅ 通过质量控制筛选高质量样本
- ✅ 迭代优化生成策略，逐步提升数据质量

**实施状态**: 核心方案，优先实施

### 4.2 预报不确定性量化 ❌ **不需要**
**说明**: 预报员在实际工作中主要参考数值模式的确定性预报结果（路径和强度），而非不确定性量化数据（如集合预报的概率分布）。因此，现有的多模式确定性预报已足够。

**当前数据充分性**: 
- ✅ 多个模式的路径预报可体现预报分歧
- ✅ 模式间差异可作为不确定性的隐式指标
- ✅ LLM可在生成的思维链中识别和表达不确定性

### 4.3 模型预报元数据 ✅ **已解决**
**原缺失内容**:
- 每次预报的模型版本信息
- 预报数据的质量标记

**解决方案**:
- ✅ 从环境场文件名直接提取：`{模型}_{版本}_{数据源}_{初始化时间}`
- ✅ 示例: `FOUR_v200_IFS_20220911T000000` → 模型=FOUR, 版本=v200, 数据源=IFS
- ✅ 在数据预处理阶段自动解析和索引

**实施状态**: 技术方案明确，易于实现

### 4.4 环境场高级诊断量 ❌ **不需要**
**说明**: 
- 当前环境场数据已包含预报员关注的关键信息（副高、海温、风切变等）
- 环境系统描述采用自然语言，适合LLM理解和推理
- 高级诊断量（涡度、位涡等）对预报员决策影响较小

**当前数据充分性**: ✅ 现有环境场描述已满足需求

### 4.5 气旋生命周期标注 ❌ **不需要**
**说明**:
- 生命周期阶段可从强度变化自动推断
- 不影响基本预报流程
- 如有需要可在后期作为辅助特征添加

**当前数据充分性**: ✅ 基于强度和位置数据可推导

## 5. 完整数据处理流程

### 5.1 数据预处理阶段

**目标**: 将现有原始数据转换为可用于LLM生成的结构化数据

**输入**:
- `input/western_pacific_typhoons_superfast.csv` - 真实路径
- `data/cds_output_trusted/*.json` - 真实环境场
- `data/track_single/*.csv` - 模型预报路径
- `data/final_single_output_trusted/*.json` - 模型预报环境场

**输出**:
- `preprocessed_data/matched_samples.jsonl` - 时空匹配后的样本

**实施步骤**:
```python
# 脚本: scripts/preprocess_data.py

1. 加载真实路径数据
2. 按storm_id和时间索引
3. For 每个预报时刻（6小时间隔）:
   a. 提取历史24小时轨迹
   b. 查找当前环境场（从cds_output_trusted）
   c. 匹配所有可用模型预报
      - 解析文件名获取模型元数据
      - 加载预报路径和环境场
   d. 提取未来72小时真值
   e. 保存匹配样本
4. 数据质量检查和统计
```

### 5.2 LLM辅助生成阶段

**目标**: 使用LLM生成预报员决策数据（含思维链）

**输入**:
- `preprocessed_data/matched_samples.jsonl`

**输出**:
- `generated_data/forecast_decisions.jsonl` - LLM生成的预报决策

**实施步骤**:
```python
# 脚本: scripts/generate_forecasts.py

1. 加载预处理样本
2. 设计提示词模板（包含思维链结构）
3. For 每个样本:
   a. 构建生成提示词
   b. 调用LLM API（GPT-4/Claude）
   c. 解析生成结果
   d. 质量检查（格式、合理性、完整性）
   e. 如通过检查，保存生成样本
4. 统计生成质量和覆盖率
5. 对低质量样本重新生成
```

**关键配置**:
- LLM模型: GPT-4-turbo 或 Claude-3.5-Sonnet
- Temperature: 0.7 (平衡创造性和准确性)
- 重试机制: 最多3次
- 质量阈值: 路径误差<500km, 气压误差<50hPa

### 5.3 SFT数据集构建阶段

**目标**: 将生成的预报决策转换为SFT训练格式

**输入**:
- `generated_data/forecast_decisions.jsonl`

**输出**:
- `training_data/sft_train.jsonl`
- `training_data/sft_val.jsonl`
- `training_data/sft_test.jsonl`

**实施步骤**:
```python
# 脚本: scripts/build_sft_dataset.py

1. 加载生成的预报决策
2. 按时间划分数据集（2006-2019训练，2020-2021验证，2022-2025测试）
3. 转换为标准格式:
   {
     "instruction": "系统提示词",
     "input": "观测+模型预报",
     "output": "思维链+预报结果"
   }
4. 保存为JSONL格式
5. 生成数据统计报告
```

### 5.4 GRPO数据集构建阶段

**目标**: 基于SFT模型生成多样化候选预报，计算奖励值

**输入**:
- SFT训练好的模型
- `training_data/sft_val.jsonl` (验证集)

**输出**:
- `training_data/grpo_train.jsonl`

**实施步骤**:
```python
# 脚本: scripts/build_grpo_dataset.py

1. 加载SFT模型
2. For 每个验证样本:
   a. 使用SFT模型生成N个候选（N=5-10）
   b. 对每个候选计算奖励值
   c. 保存候选集合和奖励
3. 质量过滤（移除奖励异常的样本）
4. 保存GRPO训练数据
```

**奖励函数**:
```python
def calculate_reward(forecast, ground_truth):
    total_reward = 0
    
    for time_step, weight in [(24, 1.0), (48, 0.7), (72, 0.5)]:
        # 路径误差
        dist_error = haversine_distance(
            forecast[f'{time_step}h']['position'],
            ground_truth[f'{time_step}h']['position']
        )
        
        # 强度误差
        pressure_error = abs(
            forecast[f'{time_step}h']['pressure'] -
            ground_truth[f'{time_step}h']['pressure']
        )
        
        wind_error = abs(
            forecast[f'{time_step}h']['wind'] -
            ground_truth[f'{time_step}h']['wind']
        )
        
        # 综合奖励（归一化）
        step_reward = weight * (
            -0.01 * dist_error +      # 每km扣0.01分
            -0.1 * pressure_error +   # 每hPa扣0.1分
            -0.2 * wind_error         # 每m/s扣0.2分
        )
        
        total_reward += step_reward
    
    return total_reward
```

## 6. 数据集规模和质量目标

### 6.1 数据规模估算

基于现有数据（2006-2025年）:
- 气旋总数: 约400-500个
- 每个气旋平均生命周期: 7-10天
- 预报时次（6小时间隔）: 约28-40个/气旋
- **总预报时刻数**: 约12,000-20,000个

考虑模型预报可用性（约50-70%匹配率）:
- **有效样本数**: 6,000-14,000个

**数据集划分**:
- **训练集** (2006-2019): 约4,000-9,000样本
- **验证集** (2020-2021): 约800-1,800样本  
- **测试集** (2022-2025): 约1,200-2,700样本

### 6.2 质量控制标准

**LLM生成样本质量要求**:
1. **格式完整性**: 100%
   - 包含所有必需的预报时效（24h/48h/72h）
   - 思维链包含6个步骤

2. **合理性**: ≥95%
   - 路径误差 < 500km（相对真值）
   - 气压误差 < 50hPa
   - 风速误差 < 20m/s

3. **逻辑连贯性**: ≥90% (人工抽检)
   - 思维链推理逻辑清晰
   - 模式分析有依据
   - 结论与分析一致

**数据筛选策略**:
- 第一轮: 自动质量检查，保留≥85%样本
- 第二轮: 人工抽检10%，整体通过率≥90%
- 第三轮: 迭代优化生成策略，重新生成低质量样本

## 7. 评估指标

### 7.1 路径预报指标
- **平均距离误差**: 各预报时效的平均位置偏差（km）
- **24h/48h/72h直接击中率**: 误差小于阈值（如75km）的比例
- **路径偏向分析**: 左偏/右偏统计

### 7.2 强度预报指标
- **气压MAE/RMSE**: 最小气压预报误差
- **风速MAE/RMSE**: 最大风速预报误差
- **强度分级准确率**: 热带低压/热带风暴/台风等级预报准确率

### 7.3 综合指标
- **预报技巧评分**: 相对于持续性预报的改进
- **模型超越率**: 优于数值模式直接预报的比例

## 8. 实施路线图（更新）

### Phase 0: 数据预处理（1-2周）
**目标**: 将现有数据进行时空匹配和结构化

**任务**:
1. 开发数据预处理脚本
   - 真实路径数据加载和索引
   - 环境场数据解析
   - 模型预报数据匹配
   - 时空对齐算法实现

2. 生成预处理数据集
   - 运行完整预处理流程
   - 数据质量检查
   - 统计可用样本数量和覆盖率

3. 数据可视化和验证
   - 抽样检查匹配正确性
   - 生成数据分布报告

**交付物**:
- `scripts/preprocess_data.py`
- `preprocessed_data/matched_samples.jsonl`
- 数据统计报告

### Phase 1: LLM辅助数据生成（2-3周）
**目标**: 生成高质量的预报员决策数据

**任务**:
1. 设计提示词模板
   - 多样本迭代设计
   - 包含详细的思维链结构
   - 融入预报员决策规则

2. 批量生成预报决策
   - 配置LLM API（GPT-4/Claude）
   - 实现生成脚本和错误处理
   - 批量处理所有样本

3. 质量控制
   - 自动质量检查
   - 人工抽检和评估
   - 迭代优化生成策略

**交付物**:
- `scripts/generate_forecasts.py`
- `generated_data/forecast_decisions.jsonl`
- 生成质量评估报告

### Phase 2: SFT训练（2-3周）
**目标**: 训练基础预报模型

**任务**:
1. 构建SFT数据集
   - 转换为标准训练格式
   - 数据集划分（训练/验证/测试）
   - 数据加载器实现

2. 模型训练
   - 选择基座模型（如LLaMA-3, Qwen等）
   - 配置训练参数
   - 监控训练过程

3. 评估和优化
   - 计算预报误差指标
   - 案例分析
   - 超参数调优

**交付物**:
- `training_data/sft_*.jsonl`
- `scripts/train_sft.py`
- SFT模型checkpoint
- 评估报告

### Phase 3: GRPO优化（2-3周）
**目标**: 通过策略优化提升预报准确度

**任务**:
1. 构建GRPO数据集
   - 使用SFT模型生成候选预报
   - 计算奖励值
   - 数据质量过滤

2. GRPO训练
   - 实现GRPO算法
   - 配置奖励函数
   - 训练优化

3. 对比评估
   - SFT vs GRPO性能对比
   - 不同时效预报改进分析
   - 消融实验

**交付物**:
- `training_data/grpo_train.jsonl`
- `scripts/train_grpo.py`
- GRPO模型checkpoint
- 对比评估报告

### Phase 4: 系统集成和测试（1-2周）
**目标**: 开发可用的预报系统

**任务**:
1. 预报接口开发
   - 实时数据接入
   - 预报生成API
   - 结果格式化输出

2. 性能优化
   - 推理加速
   - 批处理优化

3. 测试和文档
   - 真实案例测试
   - 用户手册编写
   - 代码文档完善

**交付物**:
- `scripts/inference.py`
- API文档
- 使用手册

**总时间**: 8-11周

## 9. 数据格式示例（更新）

### 9.1 预处理后的匹配样本格式
```json
{
  "sample_id": "2022091100_2022254N21158",
  "storm_id": "2022254N21158",
  "storm_name": "MUIFA",
  "forecast_time": "2022-09-11T00:00:00Z",
  
  "current_state": {
    "position": {"lat": 22.6, "lon": 124.5},
    "intensity": {"pressure": 953.0, "wind": 45.0},
    "movement": {"speed": 15.2, "direction": 315}
  },
  
  "history_24h": [
    {
      "datetime": "2022-09-10T18:00:00Z",
      "position": {"lat": 22.3, "lon": 125.0},
      "intensity": {"pressure": 955.0, "wind": 43.0}
    },
    // ... 更多历史点
  ],
  
  "current_environment": {
    "source": "cds_output_trusted/cds_environment_analysis_2022-09.json",
    "systems": {
      "SubtropicalHigh": {
        "position": "东南偏东方向",
        "intensity": 5895.2,
        "description": "中等强度，提供西北向引导气流"
      },
      "OceanHeatContent": {
        "sst": 29.5,
        "description": "海洋热含量充足，有利于台风维持"
      }
    }
  },
  
  "model_forecasts": [
    {
      "model": "FOUR",
      "version": "v200",
      "source": "IFS",
      "init_time": "2022-09-11T00:00:00Z",
      "track": [
        {"time": "2022-09-12T00:00:00Z", "lat": 23.8, "lon": 124.2, "pressure": 948.0, "wind": 46.0},
        {"time": "2022-09-13T00:00:00Z", "lat": 25.0, "lon": 123.8, "pressure": 942.0, "wind": 48.0},
        {"time": "2022-09-14T00:00:00Z", "lat": 26.8, "lon": 122.5, "pressure": 945.0, "wind": 47.0}
      ],
      "environment": {
        "source": "final_single_output_trusted/FOUR_v200_IFS_2022091100_TC_Analysis_2022254N21158.json",
        "time_series": [
          // 未来环境场演变
        ]
      }
    },
    {
      "model": "GRAP",
      "version": "v100",
      "source": "GFS",
      // ... 类似结构
    }
  ],
  
  "ground_truth": {
    "24h": {"time": "2022-09-12T00:00:00Z", "lat": 24.0, "lon": 124.25, "pressure": 950.0, "wind": 45.5},
    "48h": {"time": "2022-09-13T00:00:00Z", "lat": 25.5, "lon": 123.75, "pressure": 945.0, "wind": 47.0},
    "72h": {"time": "2022-09-14T00:00:00Z", "lat": 27.0, "lon": 122.75, "pressure": 948.0, "wind": 46.0}
  }
}
```

### 9.2 LLM生成提示词示例
```
你是一位经验丰富的台风预报专家。请根据以下信息进行详细的预报分析，并给出未来72小时的路径和强度预报。

【基本信息】
- 预报时间: 2022-09-11 00:00 UTC
- 台风编号: 2022254N21158
- 台风名称: MUIFA
- 当前位置: 22.6°N, 124.5°E
- 当前强度: 中心气压 953hPa, 最大风速 45m/s
- 当前移动: 西北向, 速度 15.2 km/h

【过去24小时演变】
2022-09-10 18:00 UTC: 22.3°N, 125.0°E, 955hPa, 43m/s
2022-09-10 12:00 UTC: 22.0°N, 125.5°E, 958hPa, 42m/s
2022-09-10 06:00 UTC: 21.7°N, 126.0°E, 960hPa, 40m/s
...

分析: 过去24小时台风向西北方向移动，移动速度逐渐加快，强度持续加强，气压下降7hPa。

【当前环境场分析】
副热带高压:
- 位置: 台风东南偏东方向
- 强度: 5895.2 gpm (中等强度)
- 影响: 提供西北向引导气流
- 形态: 东西向延伸，西脊点位于台风北侧

海洋热含量:
- 海表温度: 29.5°C
- 评估: 海洋热含量充足，有利于台风维持或发展
- 分布: 台风路径上暖水区域充足

垂直风切变:
- 强度: 约5 m/s (较弱)
- 评估: 风切变较小，有利于台风结构维持

【数值模式预报】

FOUR模式 (v200, 基于IFS):
  24小时 (09-12 00UTC): 23.8°N, 124.2°E, 948hPa, 46m/s
  48小时 (09-13 00UTC): 25.0°N, 123.8°E, 942hPa, 48m/s
  72小时 (09-14 00UTC): 26.8°N, 122.5°E, 945hPa, 47m/s

GRAP模式 (v100, 基于GFS):
  24小时 (09-12 00UTC): 24.0°N, 124.0°E, 950hPa, 45m/s
  48小时 (09-13 00UTC): 25.5°N, 123.5°E, 946hPa, 46m/s
  72小时 (09-14 00UTC): 27.5°N, 122.0°E, 950hPa, 45m/s

PANG模式 (v100, 基于GFS):
  24小时 (09-12 00UTC): 23.9°N, 124.3°E, 949hPa, 45m/s
  48小时 (09-13 00UTC): 25.2°N, 123.9°E, 944hPa, 47m/s
  72小时 (09-14 00UTC): 27.0°N, 122.8°E, 947hPa, 46m/s

【预报要求】
请按以下步骤进行系统分析，并给出您的预报：

1. **形势分析**: 评估当前台风状态和所处环境配置
2. **历史趋势**: 分析过去24小时的移动和强度变化特征，识别关键趋势
3. **模式对比**: 对比各数值模式预报，分析它们的差异、一致性和各自的可信度
4. **环境演变**: 预判未来环境场变化（副高、海温、风切变等）及其对台风的影响
5. **综合判断**: 综合以上分析，给出您的路径和强度预报，说明主要依据
6. **不确定性**: 指出预报中的主要不确定因素和风险点

最后，请给出具体的预报数值：
- 24小时预报 (09-12 00UTC): 位置(纬度°N, 经度°E), 强度(中心气压hPa, 最大风速m/s)
- 48小时预报 (09-13 00UTC): 位置(纬度°N, 经度°E), 强度(中心气压hPa, 最大风速m/s)
- 72小时预报 (09-14 00UTC): 位置(纬度°N, 经度°E), 强度(中心气压hPa, 最大风速m/s)
```

### 9.3 LLM生成响应示例
```
【台风MUIFA预报分析】

**1. 形势分析**

当前台风MUIFA位于西太平洋洋面，正处于有利的发展环境中。台风中心气压953hPa，最大风速45m/s，已达到强台风级别。从所处环境来看，副热带高压位于台风东南偏东方向，强度中等（5895.2gpm），其西侧边缘为台风提供了稳定的西北向引导气流。海洋条件方面，海表温度达到29.5°C，海洋热含量充足，为台风维持和发展提供了充足的能量来源。同时，环境垂直风切变较弱（约5m/s），有利于台风对流组织和强度维持。

**2. 历史趋势**

过去24小时，台风呈现以下特征：
- 移动方向稳定：持续向西北方向移动，路径较为稳定
- 移动速度加快：从早期的较慢速度逐渐加快至15.2km/h，说明引导气流增强
- 强度持续加强：中心气压从960hPa下降至953hPa，下降7hPa，最大风速从40m/s增至45m/s，增强5m/s
- 发展态势明显：在有利环境中，台风正处于稳定加强阶段

**3. 模式对比**

三个主要数值模式的预报呈现以下特点：

路径预报：
- 一致性较好：三个模式都预报台风将继续向西北方向移动
- 位置差异：48小时预报位置差异约0.5个纬度，72小时差异约0.8个纬度
- FOUR模式(IFS)：路径偏西偏北，可能受IFS对副高强度预报偏强影响
- GRAP模式(GFS)：路径居中偏北
- PANG模式(GFS)：路径介于两者之间

强度预报：
- FOUR模式：预报最为激进，48小时达到942hPa，显示显著加强
- GRAP模式：预报相对保守，维持在945-950hPa
- PANG模式：预报居中，944-949hPa
- 差异原因：可能与不同模式对海洋热含量和风切变的模拟差异有关

可信度评估：
- FOUR(IFS)模式在西太平洋台风路径预报上历史表现较好，但强度预报有时偏激进
- GRAP和PANG(GFS)模式路径预报略显保守，但强度预报更为稳健

**4. 环境演变**

未来72小时环境场预判：

副热带高压：
- 预计维持中等强度，位置稳定
- 继续为台风提供西北向引导
- 72小时后可能略有东退，但对引导作用影响不大

海洋条件：
- 未来48小时路径上海温维持在28-30°C，热力条件持续有利
- 72小时后可能进入略冷水域，但仍在27°C以上

垂直风切变：
- 未来24-48小时维持弱切变状态
- 72小时后可能略有增强，但仍在中等以下水平

综合评估：未来72小时环境条件整体有利，前48小时最为有利，之后可能略有转差。

**5. 综合判断**

基于以上分析，我的预报如下：

路径预报：
- 采用三模式的折中路径，略偏向PANG模式
- 副高稳定，引导气流明确，路径向西北方向移动较为确定
- 移动速度维持或略有加快

强度预报：
- 未来24小时：环境最为有利，预报继续加强
- 48小时：达到或接近最强状态
- 72小时：可能因水温略降或风切变增强而略有减弱
- 综合考虑，采用介于FOUR和PANG之间的预报，比GRAP略强

主要依据：
1. 历史趋势显示台风正处于加强期
2. 环境条件（高海温、弱切变）支持强度维持或发展
3. 副高稳定提供明确引导
4. 综合多模式预报，采用折中方案

**6. 不确定性**

主要不确定因素：

1. 强度预报不确定性较大：
   - 模式间差异达6-8hPa
   - 内部动力过程（如眼墙替换）可能导致强度短期波动
   - 实际海洋热含量分布可能与分析有差异

2. 72小时后路径不确定性增加：
   - 模式分歧增大
   - 副高后期演变存在不确定性
   - 可能受其他天气系统影响

3. 环境场演变的不确定性：
   - 垂直风切变的实际演变
   - 副高强度和位置的微调

建议：密切监测台风实际强度变化和副高演变，及时调整预报。

---

**【预报结论】**

- **24小时预报** (2022-09-12 00:00 UTC):  
  位置: 23.9°N, 124.1°E  
  强度: 中心气压 948hPa, 最大风速 46m/s

- **48小时预报** (2022-09-13 00:00 UTC):  
  位置: 25.3°N, 123.7°E  
  强度: 中心气压 943hPa, 最大风速 48m/s

- **72小时预报** (2022-09-14 00:00 UTC):  
  位置: 27.1°N, 122.6°E  
  强度: 中心气压 946hPa, 最大风速 47m/s
```

### 9.4 SFT训练样本格式
```json
{
  "instruction": "你是一位台风预报专家，请根据观测数据和数值模式预报进行详细分析并给出预报。",
  "input": "[9.2节的提示词内容]",
  "output": "[9.3节的LLM生成响应]",
  "metadata": {
    "sample_id": "2022091100_2022254N21158",
    "storm_id": "2022254N21158",
    "storm_name": "MUIFA",
    "forecast_time": "2022-09-11T00:00:00Z",
    "ground_truth": {
      "24h": {"lat": 24.0, "lon": 124.25, "pressure": 950.0, "wind": 45.5},
      "48h": {"lat": 25.5, "lon": 123.75, "pressure": 945.0, "wind": 47.0},
      "72h": {"lat": 27.0, "lon": 122.75, "pressure": 948.0, "wind": 46.0}
    },
    "forecast_parsed": {
      "24h": {"lat": 23.9, "lon": 124.1, "pressure": 948.0, "wind": 46.0},
      "48h": {"lat": 25.3, "lon": 123.7, "pressure": 943.0, "wind": 48.0},
      "72h": {"lat": 27.1, "lon": 122.6, "pressure": 946.0, "wind": 47.0}
    },
    "errors": {
      "24h_distance_km": 24.3,
      "48h_distance_km": 18.7,
      "72h_distance_km": 15.2,
      "24h_pressure_error": 2.0,
      "48h_pressure_error": 2.0,
      "72h_pressure_error": 2.0
    }
  }
}
```
```json
{
  "prompt": "您是一名资深的台风预报员。请根据以下信息预报台风未来72小时的路径和强度：\n\n【当前时刻】2022-09-11 00:00 UTC\n\n【台风基本信息】\n- 编号: 2022247N26147\n- 当前位置: 22.6°N, 124.5°E\n- 当前强度: 中心气压 953hPa, 最大风速 45m/s\n\n【过去24小时移动路径】\n...(历史轨迹数据)...\n\n【当前环境场分析】\n- 副热带高压: 位于东南偏东方向，中等强度，提供西北向引导气流\n- 海表温度: 29.5°C，海洋热含量充足\n- 垂直风切变: 5m/s，有利于台风维持\n\n【数值模式预报】\nGFS模式:\n  24h: 24.0°N, 124.0°E, 950hPa\n  48h: 25.5°N, 123.5°E, 945hPa\n  72h: 27.5°N, 122.0°E, 950hPa\n\nIFS模式:\n  24h: 23.8°N, 124.2°E, 948hPa\n  48h: 25.0°N, 123.8°E, 942hPa\n  72h: 26.8°N, 122.5°E, 945hPa\n\n请给出您的预报，包括路径和强度。",
  
  "completion": "基于当前环境场分析和数值模式预报，我的预报如下：\n\n【路径预报】\n24小时: 23.9°N, 124.1°E\n48小时: 25.3°N, 123.6°E\n72小时: 27.2°N, 122.3°E\n\n【强度预报】\n24小时: 948hPa, 46m/s (略微加强)\n48小时: 943hPa, 48m/s (继续加强)\n72小时: 947hPa, 47m/s (开始减弱)\n\n【预报依据】\n1. 副高稳定，提供持续的西北向引导，台风将沿此方向移动\n2. 海温充足，垂直风切变较小，短期内有利于台风维持或略微加强\n3. 综合GFS和IFS预报，采用折中路径，强度预报偏向IFS\n4. 72小时后可能接近较冷水域或环境条件转差，强度开始减弱",
  
  "ground_truth": {
    "24h": {"lat": 24.0, "lon": 124.25, "msl": 950.0, "wind": 45.5},
    "48h": {"lat": 25.5, "lon": 123.75, "msl": 945.0, "wind": 47.0},
    "72h": {"lat": 27.0, "lon": 122.75, "msl": 948.0, "wind": 46.0}
  }
}
```

### 9.2 GRPO奖励计算示例
```python
def calculate_reward(forecast, ground_truth):
    """
    计算预报奖励值
    """
    reward = 0
    
    for time_step in [24, 48, 72]:
        # 路径误差（km）
        distance_error = haversine_distance(
            forecast[f"{time_step}h"]["position"],
            ground_truth[f"{time_step}h"]["position"]
        )
        
        # 强度误差
        pressure_error = abs(
            forecast[f"{time_step}h"]["pressure"] -
            ground_truth[f"{time_step}h"]["pressure"]
        )
        
        wind_error = abs(
            forecast[f"{time_step}h"]["wind"] -
            ground_truth[f"{time_step}h"]["wind"]
        )
        
        # 时效衰减权重
        weight = 1.0 / (time_step / 24)
        
        # 综合奖励（误差越小，奖励越高）
        step_reward = weight * (
            -0.01 * distance_error  # 每km扣0.01分
            -0.1 * pressure_error   # 每hPa扣0.1分
            -0.2 * wind_error       # 每m/s扣0.2分
        )
        
        reward += step_reward
    
    return reward
```

### 9.5 GRPO训练样本格式
```json
{
  "prompt": "[9.2节的提示词内容]",
  "candidates": [
    {
      "response": "[候选预报1，含完整思维链和预报结果]",
      "forecast": {
        "24h": {"lat": 23.8, "lon": 124.0, "pressure": 949.0, "wind": 45.0},
        "48h": {"lat": 25.1, "lon": 123.6, "pressure": 944.0, "wind": 47.0},
        "72h": {"lat": 26.9, "lon": 122.4, "pressure": 947.0, "wind": 46.0}
      },
      "reward": -15.8
    },
    {
      "response": "[候选预报2]",
      "forecast": {
        "24h": {"lat": 24.1, "lon": 124.3, "pressure": 948.0, "wind": 46.0},
        "48h": {"lat": 25.6, "lon": 123.8, "pressure": 943.0, "wind": 48.0},
        "72h": {"lat": 27.2, "lon": 122.7, "pressure": 946.0, "wind": 47.0}
      },
      "reward": -8.5
    },
    // ... 更多候选
  ],
  "ground_truth": {
    "24h": {"lat": 24.0, "lon": 124.25, "pressure": 950.0, "wind": 45.5},
    "48h": {"lat": 25.5, "lon": 123.75, "pressure": 945.0, "wind": 47.0},
    "72h": {"lat": 27.0, "lon": 122.75, "pressure": 948.0, "wind": 46.0}
  },
  "metadata": {
    "sample_id": "2022091100_2022254N21158",
    "storm_id": "2022254N21158"
  }
}
```

## 10. 注意事项与风险（更新）

### 10.1 LLM生成数据质量风险
**风险**:
- 生成的思维链可能存在逻辑不连贯
- 预报结果可能偏离真实情况过远
- 生成质量受提示词设计影响大

**缓解措施**:
- ✅ 设计详细的提示词模板，包含明确的步骤要求
- ✅ 实施多层次质量控制（格式、合理性、逻辑性）
- ✅ 使用高质量LLM（GPT-4/Claude-3.5）
- ✅ 迭代优化生成策略，对低质量样本重新生成
- ✅ 人工抽检10%样本，确保整体质量

### 10.2 数据匹配和对齐风险
**风险**:
- 预报数据不完整：某些时次可能缺少特定模型预报
- 气旋ID匹配问题：预报追踪的气旋可能与真实气旋不一致
- 时间对齐误差：不同数据源时间戳可能不完全一致

**缓解措施**:
- ✅ 建立数据索引和匹配算法
- ✅ 实施数据完整性检查，标记缺失数据
- ✅ 容忍一定的数据缺失率（50-70%匹配率可接受）
- ✅ 保留数据来源可追溯性，便于问题排查

### 10.3 模型训练风险
**风险**:
- 过拟合生成数据：模型可能学习LLM的生成模式而非真实预报逻辑
- 过度依赖数值模式：模型可能简单平均模式预报而缺乏独立判断
- 路径和强度分布偏差：训练数据可能不均衡

**缓解措施**:
- ✅ 使用真实结果作为最终监督信号（ground truth）
- ✅ GRPO阶段直接优化预报准确度，纠正SFT阶段偏差
- ✅ 正则化和early stopping防止过拟合
- ✅ 数据增强和难样本挖掘
- ✅ 监控模型对不同模式预报的依赖程度

### 10.4 成本和效率风险
**风险**:
- LLM生成成本较高（API调用费用）
- 生成时间较长，影响项目进度
- 需要大量计算资源进行模型训练

**缓解措施**:
- 估算生成成本：假设10,000样本，每样本$0.1，总成本约$1,000
- 批量处理和并发调用提高效率
- 使用开源LLM（如LLaMA-3-70B）降低成本
- 优先生成关键样本，逐步扩展数据集

### 10.5 业务应用风险
**风险**:
- 实时性要求：预报需要在有限时间内完成
- 可解释性要求：预报员需要理解模型推理
- 责任界定：错误预报的责任归属

**缓解措施**:
- ✅ 优化模型推理速度（模型量化、批处理）
- ✅ 保留思维链输出，提供完整推理过程
- ✅ 作为辅助决策工具而非替代人类预报员
- ✅ 建立人机协同预报模式

## 11. 总结

本数据集规范提供了完整的气旋预报LLM训练方案，**核心创新在于使用LLM辅助生成预报员决策数据（包括思维链）**，解决了缺乏真实预报员标注数据的难题。

### 关键要点

1. **数据生成策略**：
   - 现有数据充分：真实观测 + 模型预报已具备基础
   - LLM辅助生成：弥补预报员决策记录缺失
   - 质量控制严格：多层次检查确保数据质量

2. **训练流程**：
   - Phase 0: 数据预处理（时空匹配）
   - Phase 1: LLM辅助生成（核心环节）
   - Phase 2: SFT训练（学习预报逻辑）
   - Phase 3: GRPO优化（提升准确度）

3. **不需要的数据**：
   - ❌ 不确定性量化数据（预报员不常用）
   - ❌ 环境场高级诊断量（当前数据已充分）
   - ❌ 气旋生命周期标注（可自动推导）

4. **预期成果**：
   - 数据集规模：6,000-14,000样本
   - 训练周期：8-11周
   - 模型能力：具备类人预报决策能力，输出完整思维链

### 下一步行动

建议按以下优先级推进：
1. **立即开始**：Phase 0 数据预处理，验证数据匹配可行性
2. **小规模试验**：生成100-500个样本，验证LLM生成质量
3. **评估成本**：确认LLM API调用成本和时间可接受
4. **全面实施**：确认可行后，执行完整数据生成和训练流程
